'use client';

import * as React from 'react';
import { CommunityFeedCard } from '@/components/ui/community-feed-card';
import { QnaCard } from '@/components/ui/qna-card';
import { PromotionCard } from '@/components/ui/promotion-card';
import { Chip } from '@/components/ui/chip';
import { RecommendedPostsPanel } from '@/components/ui/recommended-posts-panel';
import { RecommendedFollowersPanel } from '@/components/ui/recommended-followers-panel';
import { LoadMore } from '@/components/ui/load-more';
import { Avatar, AvatarImage, AvatarFallback } from '@/components/ui/avatar';
import { MessageSquare, Users, X, ExternalLink, Loader2 } from 'lucide-react';
import { cn } from '@/lib/utils';
// Mock 데이터 import (로컬 프로토타이핑용)
import {
  mockPostsData,
  mockQuestionsData,
  mockRecommendedPosts,
  mockRecommendedFollowers,
  mockPromotionData
} from '@/lib/data/community-mock';

// 이전에 사용되던 백업 데이터는 lib/data/community-mock.ts로 이동됨

type UserProfile = {
  id: number;
  name: string;
  image_url: string;
  headline: string;
  description: string;
  small_image_url: string;
};

type SelectedContent = {
  type: 'post' | 'qna';
  id: string;
  userProfile?: UserProfile;
};

export default function CommunityPage() {
  const [selectedInterests, setSelectedInterests] = React.useState<string[]>([]);
  const [contentFilter, setContentFilter] = React.useState<'feed' | 'qna' | 'promotion' | 'following'>('feed');
  const [drawerOpen, setDrawerOpen] = React.useState(false);
  const [selectedContent, setSelectedContent] = React.useState<SelectedContent | null>(null);
  const [currentPage, setCurrentPage] = React.useState(1);

  // 로컬 Mock 데이터 사용 (API 대신)
  const postsData = mockPostsData;
  const questionsData = mockQuestionsData;
  const isLoadingPosts = false;
  const isLoadingQuestions = false;
  const postsError = null;
  const questionsError = null;

  const handleOpenPost = (postId: string, userProfile?: UserProfile) => {
    setSelectedContent({ type: 'post', id: postId, userProfile });
    setDrawerOpen(true);
  };

  const handleOpenQna = (qnaId: string) => {
    setSelectedContent({ type: 'qna', id: qnaId });
    setDrawerOpen(true);
  };

  const handleCloseDrawer = () => {
    setDrawerOpen(false);
    setTimeout(() => setSelectedContent(null), 300); // Clear after animation
  };

  const handleLoadMore = () => {
    setCurrentPage(prev => prev + 1);
  };

  // Interest categories
  const interestCategories = [
    { id: 'frontend', label: 'Frontend' },
    { id: 'backend', label: 'Backend' },
    { id: 'ai-ml', label: 'AI/ML' },
    { id: 'design', label: 'Design' },
    { id: 'management', label: 'Management' },
    { id: 'career', label: 'Career' },
  ];

  // Mix all content naturally by interleaving different types
  const allContent = React.useMemo(() => {
    // Use API data for feed and QnA, mock data for promotion
    const feedItems = (postsData?.results || []).map((item, idx) => ({
      type: 'feed' as const,
      data: item,
      originalIndex: idx,
    }));

    const qnaItems = (questionsData?.results || []).map((item, idx) => ({
      type: 'qna' as const,
      data: item,
      originalIndex: idx,
    }));

    const promotionItems = mockPromotionData.map((item, idx) => ({
      type: 'promotion' as const,
      data: item,
      originalIndex: idx,
    }));

    // Interleave items to mix them naturally
    const result = [];
    const maxLength = Math.max(feedItems.length, qnaItems.length, promotionItems.length);

    for (let i = 0; i < maxLength; i++) {
      // Add items in a rotating pattern: feed -> qna -> promotion -> feed -> qna...
      if (i < feedItems.length) result.push(feedItems[i]);
      if (i < qnaItems.length) result.push(qnaItems[i]);
      if (i < promotionItems.length) result.push(promotionItems[i]);
    }

    return result;
  }, [postsData, questionsData]);

  // Filter content based on selected filter
  const filteredContent = React.useMemo(() => {
    if (contentFilter === 'following') {
      // TODO: Implement following filter logic
      return allContent;
    }
    return allContent.filter(item => item.type === contentFilter);
  }, [allContent, contentFilter]);

  // Loading state
  const isLoading = isLoadingPosts || isLoadingQuestions;

  // Error state
  const hasError = postsError || questionsError;

  // Check if there's more data to load
  const hasMoreData = postsData?.next || questionsData?.next;

  return (
    <div className="grid grid-cols-1 lg:grid-cols-12 gap-4">
      {/* Main Content */}
      <main className="lg:col-span-9">
        <div className="space-y-4">
          {/* Header Section */}
          <div className="pt-16 pb-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-6">
                <div className="flex items-center gap-3">
                  <MessageSquare className="h-10 w-10 text-slate-700" />
                  <h1 className="text-3xl font-bold text-slate-900">Community</h1>
                </div>
              </div>

              <div className="flex items-center gap-3">
                <div className="flex items-center gap-2">
                  <Chip
                    variant={contentFilter === 'feed' ? 'selected' : 'default'}
                    onClick={() => setContentFilter('feed')}
                  >
                    <MessageSquare className="h-4 w-4" />
                    Feed
                  </Chip>
                  <Chip
                    variant={contentFilter === 'qna' ? 'selected' : 'default'}
                    onClick={() => setContentFilter('qna')}
                  >
                    Q&A
                  </Chip>
                  <Chip
                    variant={contentFilter === 'promotion' ? 'selected' : 'default'}
                    onClick={() => setContentFilter('promotion')}
                  >
                    홍보
                  </Chip>
                  <Chip
                    variant={contentFilter === 'following' ? 'selected' : 'default'}
                    onClick={() => setContentFilter('following')}
                  >
                    <Users className="h-4 w-4" />
                    팔로잉
                  </Chip>
                </div>
              </div>
            </div>
          </div>

          {/* Loading State */}
          {isLoading && filteredContent.length === 0 && (
            <div className="flex items-center justify-center py-12">
              <Loader2 className="h-8 w-8 animate-spin text-slate-400" />
              <span className="ml-3 text-slate-600">Loading content...</span>
            </div>
          )}

          {/* Error State */}
          {hasError && !isLoading && (
            <div className="text-center py-12">
              <p className="text-slate-600">Failed to load content. Please try again later.</p>
            </div>
          )}

          {/* Empty State */}
          {!isLoading && !hasError && filteredContent.length === 0 && (
            <div className="text-center py-12">
              <p className="text-slate-600">No content available.</p>
            </div>
          )}

          {/* Unified 2-Column Grid */}
          {filteredContent.length > 0 && (
            <div className="columns-1 md:columns-2 gap-6 space-y-6">
              {filteredContent.map((item, idx) => {
                if (item.type === 'feed') {
                  const post = item.data;
                  // Map API response to component props
                  const userProfile: UserProfile = {
                    id: post.userid,
                    name: post.author_name,
                    image_url: '', // API doesn't provide this in list view
                    headline: '',
                    description: '',
                    small_image_url: '',
                  };

                  return (
                    <div key={`feed-${post.id}`} className="break-inside-avoid mb-6">
                      <CommunityFeedCard
                        userProfile={userProfile}
                        content={post.description}
                        contentHtml={post.description} // API doesn't provide HTML separately in list
                        createdAt={post.createdat}
                        stats={{
                          likeCount: 0, // Not available in list view
                          replyCount: post.comment_count || 0,
                          repostCount: 0,
                          viewCount: 0,
                        }}
                        imageUrls={[]} // Not available in list view
                        onClick={() => handleOpenPost(post.id.toString(), userProfile)}
                        onLike={() => console.log('Like')}
                        onReply={() => console.log('Reply')}
                        onRepost={() => console.log('Repost')}
                        onShare={() => console.log('Share')}
                        onBookmark={() => console.log('Bookmark')}
                        onMore={() => console.log('More')}
                      />
                    </div>
                  );
                } else if (item.type === 'qna') {
                  const question = item.data;
                  return (
                    <div key={`qna-${question.id}`} className="break-inside-avoid mb-6">
                      <QnaCard
                        title={question.title}
                        description={question.description}
                        createdAt={question.createdat}
                        updatedAt={question.updatedat}
                        status={question.status}
                        isPublic={question.ispublic}
                        answerCount={0} // Not available in QuestionListItem
                        commentCount={0}
                        likeCount={0}
                        dislikeCount={0}
                        viewCount={0}
                        hashTagNames=""
                        qnaId={question.id}
                        onClick={() => handleOpenQna(question.id.toString())}
                        onLike={() => console.log('Like')}
                        onDislike={() => console.log('Dislike')}
                      />
                    </div>
                  );
                } else if (item.type === 'promotion') {
                  const promo = item.data;
                  return (
                    <div key={`promotion-${idx}`} className="break-inside-avoid mb-6">
                      <PromotionCard
                        variant="default"
                        {...promo}
                      />
                    </div>
                  );
                }
                return null;
              })}
            </div>
          )}

          {/* Load More */}
          {filteredContent.length > 0 && (
            <LoadMore
              hasMore={!!hasMoreData}
              loading={isLoading}
              onLoadMore={handleLoadMore}
            />
          )}
        </div>
      </main>

      {/* Right Sidebar */}
      <aside className="lg:col-span-3">
        <div className="space-y-4 pt-16">
          {/* Recommended Posts */}
          <RecommendedPostsPanel
            posts={mockRecommendedPosts}
            maxItems={5}
          />

          {/* Recommended Followers */}
          <RecommendedFollowersPanel
            followers={mockRecommendedFollowers}
            maxItems={5}
            onFollow={(userId) => console.log('Follow:', userId)}
            onUnfollow={(userId) => console.log('Unfollow:', userId)}
          />
        </div>
      </aside>

      {/* Right Drawer */}
      <div
        className={cn(
          "fixed inset-y-0 right-0 z-50 w-full md:w-[600px] lg:w-[700px] bg-white shadow-2xl transform transition-transform duration-300 ease-in-out overflow-y-auto",
          drawerOpen ? "translate-x-0" : "translate-x-full"
        )}
      >
        {selectedContent && (
          <div className="h-full flex flex-col">
            {/* Drawer Header */}
            <div className="sticky top-0 z-10 bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between">
              {selectedContent.type === 'post' && selectedContent.userProfile ? (
                <div className="flex items-center gap-3 flex-1">
                  <button
                    onClick={() => window.open(`/profile/${selectedContent.userProfile?.id}`, '_blank')}
                    className="flex items-center gap-3 hover:opacity-80 transition-opacity group"
                    aria-label="프로필 보기"
                  >
                    <Avatar className="h-10 w-10">
                      <AvatarImage
                        src={selectedContent.userProfile.small_image_url || selectedContent.userProfile.image_url}
                        alt={selectedContent.userProfile.name}
                      />
                      <AvatarFallback>
                        {selectedContent.userProfile.name.charAt(0)}
                      </AvatarFallback>
                    </Avatar>
                    <div className="flex flex-col">
                      <div className="flex items-center gap-1.5">
                        <span className="text-sm font-semibold text-slate-900">
                          {selectedContent.userProfile.name}
                        </span>
                        <ExternalLink className="h-3.5 w-3.5 text-slate-400 group-hover:text-slate-600" />
                      </div>
                      <span className="text-xs text-slate-600">
                        {selectedContent.userProfile.headline}
                      </span>
                    </div>
                  </button>
                </div>
              ) : (
                <h2 className="text-lg font-semibold text-slate-900">
                  {selectedContent.type === 'post' ? '게시글' : '질문'}
                </h2>
              )}
              <button
                onClick={handleCloseDrawer}
                className="p-2 hover:bg-slate-100 rounded-full transition-colors"
                aria-label="닫기"
              >
                <X className="h-5 w-5 text-slate-600" />
              </button>
            </div>

            {/* Drawer Content */}
            <div className="flex-1 overflow-y-auto">
              {selectedContent.type === 'post' && (
                <iframe
                  src={`/community/post/${selectedContent.id}?drawer=true`}
                  className="w-full h-full border-0"
                  title="Post Detail"
                />
              )}
              {selectedContent.type === 'qna' && (
                <iframe
                  src={`/community/qna/${selectedContent.id}?drawer=true`}
                  className="w-full h-full border-0"
                  title="QnA Detail"
                />
              )}
            </div>
          </div>
        )}
      </div>

      {/* Backdrop */}
      {drawerOpen && (
        <div
          className="fixed inset-0 bg-black/50 z-40 transition-opacity duration-300"
          onClick={handleCloseDrawer}
        />
      )}
    </div>
  );
}
